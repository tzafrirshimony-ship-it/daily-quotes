<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>העצמה יומית</title>
    
    <!-- PWA Metadata -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"העצמה יומית","short_name":"העצמה","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#3b82f6","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3135/3135715.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="העצמה יומית">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }
        .quote-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .locked-state {
            filter: blur(20px);
            user-select: none;
            pointer-events: none;
            opacity: 0.2;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .checking { animation: pulse 1s infinite; }
    </style>
</head>
<body>

    <div class="w-full max-w-md bg-white rounded-[2.5rem] p-8 quote-card text-center relative overflow-hidden">
        
        <!-- לוח אבחון טכני -->
        <div id="debug-panel" class="mb-6 p-4 bg-slate-50 rounded-2xl text-right text-[11px] border border-slate-200">
            <h3 class="font-bold mb-2 text-slate-700 border-b pb-1">אבחון מערכת:</h3>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span>פרוטוקול אבטחה (HTTPS)</span>
                    <span id="https-status" class="status-dot bg-red-400"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span>שירות רקע (Worker)</span>
                    <span id="sw-status" class="status-dot bg-red-400"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span>הרשאות התראה</span>
                    <span id="perm-status" class="status-dot bg-red-400"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span>מצב אפליקציה (Home Screen)</span>
                    <span id="standalone-status" class="status-dot bg-red-400"></span>
                </div>
            </div>
            <div id="debug-msg" class="mt-3 p-2 bg-red-50 text-red-600 rounded-lg hidden text-center font-bold"></div>
            <button onclick="attemptSetup()" class="mt-4 w-full py-2 bg-blue-50 text-blue-600 font-bold rounded-lg border border-blue-100 hover:bg-blue-100 transition active:scale-95">
                נסה להפעיל שירותים שוב
            </button>
        </div>

        <div class="mb-6 pb-6 border-b border-slate-100 text-right">
            <label class="block text-sm font-bold text-slate-500 mb-2">שעת התראה:</label>
            <div class="flex gap-2 justify-center">
                <input type="time" id="reminder-time" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="saveSettings()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-blue-700 transition active:scale-95">שמור</button>
            </div>
            <button onclick="testNotification()" class="mt-3 w-full text-xs text-blue-400 font-medium">שלח התראת בדיקה</button>
        </div>

        <header class="mb-8">
            <div id="status-icon" class="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg transition-all duration-700">
                <svg id="icon-svg" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight" id="app-title">המשפט היומי</h1>
            <p id="date-display" class="text-sm font-medium text-slate-400 mt-1"></p>
        </header>

        <main class="mb-10 min-h-[140px] flex items-center justify-center relative">
            <div id="lock-overlay" class="absolute inset-0 z-20 flex items-center justify-center">
                <div class="bg-white/90 p-5 rounded-3xl shadow-sm border border-slate-50">
                    <p class="text-blue-600 font-bold" id="lock-message">ההשראה תגיע בשעה שקבעת</p>
                </div>
            </div>
            
            <div id="quote-container" class="locked-state w-full">
                <p id="quote-text" class="text-xl md:text-2xl font-bold text-slate-700 leading-relaxed px-4"></p>
            </div>
        </main>

        <footer id="action-buttons" class="hidden">
            <button onclick="shareQuote()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                שתף עם חברים
            </button>
        </footer>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-full opacity-0 transition-all duration-300 pointer-events-none text-sm font-bold z-50">
        הגדרות עודכנו!
    </div>

    <script>
        const quotes = [
            "הדרך היחידה לעשות עבודה נהדרת היא לאהוב את מה שאתה עושה.",
            "העתיד שייך לאלו המאמינים ביופי של החלומות שלהם.",
            "כל יום הוא הזדמנות שנייה.",
            "אל תספור את הימים, גרום לימים להיספר.",
            "ההצלחה היא לא סופית, והכישלון אינו גורלי.",
            "מה שאתה עושה היום יכול לשפר את כל המחרים שלך.",
            "אל תחכה להזדמנות, צור אותה.",
            "השינוי מתחיל בך.",
            "גם מסע של אלף מייל מתחיל בצעד אחד קטן.",
            "תאמין שאתה יכול, ואתה כבר בחצי הדרך.",
            "אתה חזק יותר ממה שאתה חושב.",
            "תהיה אדיב לעצמך."
        ];

        // בדיקה אם אנחנו בתוך IFRAME (תצוגה מקדימה)
        const isIframe = window.self !== window.top;

        async function attemptSetup() {
            const debugMsg = document.getElementById('debug-msg');
            debugMsg.classList.add('hidden');

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                logDebug("חובה להשתמש ב-HTTPS כדי שהתראות יעבדו.");
                return;
            }
            document.getElementById('https-status').classList.replace('bg-red-400', 'bg-green-400');

            if (isIframe) {
                logDebug("לא ניתן להפעיל שירותי רקע בתוך תצוגה מקדימה. העלה ל-GitHub ובדוק שם.");
                return;
            }

            await registerServiceWorker();
            updateStatus();
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) return;

            const swCode = `
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                self.addEventListener('notificationclick', e => {
                    e.notification.close();
                    e.waitUntil(clients.matchAll({type: 'window'}).then(c => {
                        if (c.length > 0) return c[0].focus();
                        return clients.openWindow('/');
                    }));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            try {
                await navigator.serviceWorker.register(swUrl);
                document.getElementById('sw-status').classList.replace('bg-red-400', 'bg-green-400');
            } catch (err) {
                console.error('SW Error:', err);
                logDebug("שירות הרקע נחסם עקב מדיניות אבטחה.");
            }
        }

        function logDebug(msg) {
            const el = document.getElementById('debug-msg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        function updateStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            if (isStandalone) {
                document.getElementById('standalone-status').classList.replace('bg-red-400', 'bg-green-400');
            }

            if (window.Notification && Notification.permission === 'granted') {
                document.getElementById('perm-status').classList.replace('bg-red-400', 'bg-green-400');
            }
        }

        function saveSettings() {
            const timeVal = document.getElementById('reminder-time').value;
            if (timeVal) {
                localStorage.setItem('reminderTime', timeVal);
                showToast("הגדרות נשמרו!");
                localStorage.removeItem('lastNotifiedDate');
                
                if (window.Notification) {
                    Notification.requestPermission().then(perm => {
                        updateStatus();
                        if (perm === 'denied') alert("התראות חסומות בהגדרות המכשיר.");
                    });
                }
                updateUI();
            }
        }

        function testNotification() {
            if (Notification.permission === 'granted') {
                sendNotification("בדיקת מערכת ✅", "מעולה! ההתראות שלך עובדות.");
            } else {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') sendNotification("בדיקת מערכת ✅", "עכשיו זה עובד!");
                    else alert("יש לאשר התראות בהגדרות.");
                    updateStatus();
                });
            }
        }

        function sendNotification(title, body) {
            if (Notification.permission !== 'granted') return;

            const options = {
                body: body,
                icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                vibrate: [200, 100, 200]
            };

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification(title, options);
                }).catch(() => new Notification(title, options));
            } else {
                new Notification(title, options);
            }
        }

        function updateUI() {
            const now = new Date();
            const currentStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const savedTime = localStorage.getItem('reminderTime') || "08:00";
            document.getElementById('reminder-time').value = savedTime;

            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('date-display').innerText = now.toLocaleDateString('he-IL', options);

            const dayIdx = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quote = quotes[dayIdx % quotes.length];
            document.getElementById('quote-text').innerText = quote;

            if (currentStr >= savedTime) {
                document.getElementById('quote-container').classList.remove('locked-state');
                document.getElementById('lock-overlay').classList.add('hidden');
                document.getElementById('action-buttons').classList.remove('hidden');
                document.getElementById('app-title').innerText = "ההשראה שלך";
                document.getElementById('status-icon').classList.replace('bg-blue-500', 'bg-green-500');
                
                if (currentStr === savedTime && localStorage.getItem('lastNotifiedDate') !== now.toDateString()) {
                    sendNotification('המשפט היומי הגיע!', quote);
                    localStorage.setItem('lastNotifiedDate', now.toDateString());
                }
            } else {
                document.getElementById('quote-container').classList.add('locked-state');
                document.getElementById('lock-overlay').classList.remove('hidden');
                document.getElementById('lock-message').innerText = `ההשראה תגיע בשעה ${savedTime}`;
                document.getElementById('status-icon').classList.replace('bg-green-500', 'bg-blue-500');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        function shareQuote() {
            const text = document.getElementById('quote-text').innerText;
            if (navigator.share) {
                navigator.share({ title: 'העצמה יומית', text: `"${text}"`, url: window.location.href });
            }
        }

        window.onload = () => {
            attemptSetup();
            updateUI();
        };
        setInterval(updateUI, 15000);
    </script>
</body>
</html>
